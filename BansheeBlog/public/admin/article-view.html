<script type="text/template" data-template id="article-view" >
    <div style="margin: 0 auto; max-width: 800px" class="flat">
        <span>Articles</span>
        <ul data-bindings="articleItems -> children"></ul>
    </div>
</script>

<script type="text/css" data-style for="article-view">
    #article-list:empty:after {
        content: 'No articles created yet';
        color: var(--weak-font-color);
        font-size: var(--small-font-size);
    }
</script>

<script type="text/javascript" data-behaviour for="article-view">
    function onBind() {
        return {
            afterBind: async () => {

                const editArticle = article => {
                    request("GET", `/admin/article/${article.Id}/markdown`).then(markdown => {
                        const bindingContext = {
                            id: article.Id,
                            title: article.Title,
                            slug: article.Slug,
                            markdown: markdown.Content,
                            tags: article.Tags.split(",").join(" "),
                            public: article.Public
                        };
                        dataBinder.render('article-editor', 'content', bindingContext);
                    });
                };
                
                const articles = await request("GET", "/admin/articles");
                
                

                this.articleItems = articles.map(article => {
                    const articleElement = render(h("li", {class: "article-item"}, article.Title));
                    const deleteButton = render(h("i", {class: "material-icons"}, "delete"));
                    const editButton = render(h("i", {class: "material-icons"}, "create"));
                    const publicButton = render(h("i", {class: "material-icons toggle" + (article.Public ? "" : " toggled-off")}, "public"));

                    let deletePressed = 0;
                    const setDeleteToNormal = () => {
                        deleteButton.style.color = "inherit";
                        deletePressed = 0;
                    };
                    deleteButton.onclick = () => {
                        if (deletePressed === 0){
                            deletePressed = 1;
                            deleteButton.style.color = "#ef5350";
                            setTimeout(setDeleteToNormal, 2000);
                        }
                        else if (deletePressed === 1){
                            deletePressed = 2;
                            deleteButton.style.color = "#b71c1c";
                        }
                        else {
                            articleElement.remove();
                        }
                    };

                    editButton.onclick = () => editArticle(article);

                    publicButton.onclick = () => {
                        article.Public = !article.Public;
                        request("PUT", "/admin/article/meta", article).then(() => {
                            if (article.Public) {
                                publicButton.classList.remove("toggled-off");
                            }
                            else {
                                publicButton.classList.add("toggled-off");
                            }
                        })

                    };


                    articleElement.appendChild(deleteButton);
                    articleElement.appendChild(editButton);
                    articleElement.appendChild(publicButton);
                    return articleElement;
                });
            }
        };
    }
</script>